<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; width: 100%; }
    .leaflet-container { font-family: sans-serif; }

    /* marker titik biru lokasi kost */
    .kost-location-dot {
      width: 18px;
      height: 18px;
      background: #4285F4;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 0 10px #4285F4;
    }

    /* marker titik bulat merah untuk lokasi pilihan (lokasi sekarang / tujuan) */
    .my-location-dot,
    .destination-dot {
      width: 18px;
      height: 18px;
      background: #E53935;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 0 10px #E53935;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    (function() {
      // MODE: 'normal' or 'destination'
      window._mode = 'normal';

      // init map (Makassar default)
      var map = L.map('map', { zoomControl: true }).setView([-5.147665, 119.432731], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      window._lastClick = null;
      window._lastMarker = null;        // marker utama (kost atau titik pilihan)
      window._myLocationMarker = null;  // marker lokasi saya (biru)
      window._destinationMarker = null; // marker tujuan (oranye)
      window._routeLayer = null;        // polyline rute jalan
      window._allKostMarkers = [];

      // icon khusus untuk lokasi kost (bulat biru)
      var kostIcon = L.divIcon({
        className: 'kost-location-dot',
        iconSize: [18, 18]
      });

      // icon khusus untuk titik lokasi yang dipilih (sekarang/tujuan) bulat merah
      var destinationIcon = L.divIcon({
        className: 'destination-dot',
        iconSize: [18, 18]
      });

      // single click handler: hanya simpan _lastClick & marker
      map.on('click', function(e) {
        // tetap simpan click walau mode berbeda (berguna jika dev butuh)
        window._lastClick = { lat: e.latlng.lat, lng: e.latlng.lng };
        // jika mode readonly, jangan pindah marker apa pun
        if (window._mode === 'readonly') {
          return;
        }
        // jika mode normal, juga tampil marker pada klik satu (opsional)
        if (window._mode === 'normal') {
          if (window._lastMarker) map.removeLayer(window._lastMarker);
          window._lastMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
        }
      });

      // double-click handler: hanya dipakai saat mode == 'destination'
      map.on('dblclick', function(e) {
        if (window._mode === 'destination') {
          window._lastClick = { lat: e.latlng.lat, lng: e.latlng.lng };

          if (window._lastMarker) {
            map.removeLayer(window._lastMarker);
          }

          window._lastMarker = L.marker([e.latlng.lat, e.latlng.lng], { icon: destinationIcon }).addTo(map);

          // kirim pesan ke Flutter via channel ToFlutter (webview_flutter)
          try {
            if (window.ToFlutter && window.ToFlutter.postMessage) {
              window.ToFlutter.postMessage(JSON.stringify({
                type: 'destination_selected',
                lat: e.latlng.lat,
                lng: e.latlng.lng
              }));
            } else if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
              // fallback untuk inappwebview jika digunakan
              window.flutter_inappwebview.callHandler('ToFlutter', JSON.stringify({
                type: 'destination_selected',
                lat: e.latlng.lat,
                lng: e.latlng.lng
              }));
            }
          } catch (err) {
            console.warn('Posting message to Flutter failed:', err);
          }
        }
      });

      // fungsi helper yang dipanggil dari Flutter
      window.getLastClick = function() {
        return JSON.stringify(window._lastClick);
      };

      window.setMarker = function(lat, lng) {
        if (window._lastMarker) map.removeLayer(window._lastMarker);
        window._lastMarker = L.marker([lat, lng], { icon: kostIcon }).addTo(map);
        map.panTo([lat, lng]);
      };

      window.setView = function(lat, lng, zoom) {
        map.setView([lat, lng], zoom || map.getZoom());
      };

      // set mode dari Flutter: 'normal' atau 'destination'
      window.setMode = function(mode) {
        if (mode === 'destination' || mode === 'normal' || mode === 'readonly') {
          window._mode = mode;
        } else {
          window._mode = 'normal';
        }
      };

      // set marker khusus "lokasi saya" (ikon biru)
      window.setMyLocation = function(lat, lng) {
        if (window._myLocationMarker) {
          map.removeLayer(window._myLocationMarker);
        }

        var redIcon = L.divIcon({
          className: "my-location-dot",
          iconSize: [18, 18]
        });

        window._myLocationMarker = L.marker([lat, lng], { icon: redIcon }).addTo(map);
        map.setView([lat, lng], 16);
      };

      // set marker khusus lokasi tujuan (ikon oranye)
      window.setDestinationLocation = function(lat, lng) {
        if (window._destinationMarker) {
          map.removeLayer(window._destinationMarker);
        }

        window._destinationMarker = L.marker([lat, lng], { icon: destinationIcon }).addTo(map);
      };

      // hapus marker lokasi saya
      window.clearMyLocation = function() {
        if (window._myLocationMarker) {
          try { map.removeLayer(window._myLocationMarker); } catch (e) {}
          window._myLocationMarker = null;
        }
      };

      // hapus marker tujuan (termasuk _lastMarker yang dipakai untuk titik tujuan)
      window.clearDestination = function() {
        if (window._destinationMarker) {
          try { map.removeLayer(window._destinationMarker); } catch (e) {}
          window._destinationMarker = null;
        }
        if (window._lastMarker) {
          try { map.removeLayer(window._lastMarker); } catch (e) {}
          window._lastMarker = null;
        }
      };

      // tampilkan semua titik kost (dipanggil dari Flutter)
      // dataKost: array of { lat: number, lng: number, name?: string }
      window.showAllKostMarkers = function(dataKost) {
        try {
          if (!Array.isArray(dataKost)) return;

          // hapus marker kost lama
          if (Array.isArray(window._allKostMarkers)) {
            window._allKostMarkers.forEach(function(m) {
              try { map.removeLayer(m); } catch (e) {}
            });
          }
          window._allKostMarkers = [];

          dataKost.forEach(function(item) {
            if (!item) return;
            var lat = parseFloat(item.lat);
            var lng = parseFloat(item.lng);
            if (!isFinite(lat) || !isFinite(lng)) return;

            var marker = L.marker([lat, lng], { icon: kostIcon }).addTo(map);
            if (item.name) {
              marker.bindPopup(String(item.name));
            }
            window._allKostMarkers.push(marker);
          });

          if (window._allKostMarkers.length > 0) {
            var group = L.featureGroup(window._allKostMarkers);
            map.fitBounds(group.getBounds().pad(0.2));
          }
        } catch (err) {
          console.warn('showAllKostMarkers error:', err);
        }
      };

      // fit bounds untuk marker kost (_lastMarker) dan tujuan (_destinationMarker)
      window.fitToKostAndDestination = function() {
        var markers = [];
        if (window._lastMarker) {
          markers.push(window._lastMarker);
        }
        if (window._destinationMarker) {
          markers.push(window._destinationMarker);
        }

        if (markers.length === 0) return;

        var group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      };

      // gambar rute jalan antara dua titik (kost dan tujuan)
      // menggunakan OSRM public routing API (driving)
      window.drawRouteBetweenPoints = function(fromLat, fromLng, toLat, toLng) {
        try {
          if (window._routeLayer) {
            try { map.removeLayer(window._routeLayer); } catch (e) {}
            window._routeLayer = null;
          }

          var url = 'https://router.project-osrm.org/route/v1/driving/' +
            fromLng + ',' + fromLat + ';' + toLng + ',' + toLat +
            '?overview=full&geometries=geojson';

          fetch(url)
            .then(function(r) { return r.json(); })
            .then(function(data) {
              if (!data || !data.routes || !data.routes.length) return;
              var geom = data.routes[0].geometry;
              window._routeLayer = L.geoJSON(geom, {
                style: {
                  color: '#1C3B98',
                  weight: 4,
                  opacity: 0.9
                }
              }).addTo(map);
            })
            .catch(function(err) {
              console.warn('drawRouteBetweenPoints error:', err);
            });
        } catch (err2) {
          console.warn('drawRouteBetweenPoints outer error:', err2);
        }
      };

      // simpan map handle global untuk debug jika perlu
      window._leaflet_map = map;
    })();
  </script>
</body>
</html>
